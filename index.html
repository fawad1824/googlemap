<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Current Location and Live Tracking on Google Maps</title>
    <style>
      /* Define the size of the map */
      #map {
        height: 100%;
        width: 100%;
      }
      /* Make the map fill the screen */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      h3 {
        text-align: center;
        margin: 10px;
      }
      #trackBtn {
        position: absolute;
        top: 20px;
        left: 20px;
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        font-size: 16px;
        cursor: pointer;
        display: none; /* Hide the button initially */
        z-index: 10;
      }
      #trackBtn:disabled {
        background-color: gray;
        cursor: not-allowed;
      }
      #statusMessage {
        position: absolute;
        top: 80px;
        left: 20px;
        font-size: 18px;
        color: green;
        font-weight: bold;
        display: none; /* Hide initially */
      }
      #drivingIcon {
        position: absolute;
        top: 80px;
        left: 180px;
        font-size: 30px;
        color: #ff9800;
        display: none; /* Hide initially */
      }
      .arrow {
        position: absolute;
        width: 50px;
        height: 50px;
        background-color: transparent;
        background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Arrow_icon_2.svg/120px-Arrow_icon_2.svg.png');
        background-size: contain;
        background-repeat: no-repeat;
        z-index: 15;
        display: none; /* Initially hide the arrow */
      }
    </style>
  </head>
  <body>
    <h3>My Current Location and Live Tracking</h3>
    <div id="map"></div>
    <button id="trackBtn" onclick="startTracking()">Track</button>
    <div id="statusMessage">You are in Driving Mode...</div>
    <div id="drivingIcon">ðŸš—</div>
    <div id="leftArrow" class="arrow"></div>
    <div id="rightArrow" class="arrow"></div>

    <script>
      let map;
      let userMarker;
      let selectedMarker;
      let userLocation = null;
      let selectedLocation = null;
      let route;
      let directionsService;
      let directionsRenderer;
      let routeSteps = []; // To store the steps of the route for real-time tracking
      let watchID = null; // To store watch position ID
      let prevLocation = null;
      let directionArrowLeft = document.getElementById("leftArrow");
      let directionArrowRight = document.getElementById("rightArrow");
      let markers = []; // To store markers on the map

      // Initialize and add the map
      function initMap() {
        // Create a map centered at a default location (if geolocation fails)
        const defaultLocation = { lat: -34.397, lng: 150.644 };

        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: defaultLocation, // Start with default location
        });

        // Initialize Directions services
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
        });

        // Try to get the current location
        if (navigator.geolocation) {
          watchID = navigator.geolocation.watchPosition(
            function (position) {
              userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };

              // Set the map center to user's current location
              if (!userMarker) {
                userMarker = new google.maps.Marker({
                  position: userLocation,
                  map: map,
                  title: "You are here!",
                  icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10, // Size of the circle
                    fillColor: "blue",
                    fillOpacity: 0.5,
                    strokeWeight: 0,
                  },
                });
              } else {
                userMarker.setPosition(userLocation); // Update the position of the marker
              }

              map.setCenter(userLocation); // Update map center to current location

              // Handle direction arrows (headlights)
              if (prevLocation) {
                handleDirection(prevLocation, userLocation);
              }
              prevLocation = userLocation;
            },
            function () {
              // Handle location access denial
              alert("Geolocation failed or permission denied.");
            }
          );
        } else {
          alert("Geolocation is not supported by this browser.");
        }

        // Click event to set a second location (destination)
        map.addListener("click", function (e) {
          if (!selectedLocation && !document.getElementById("trackBtn").disabled) {
            if (selectedMarker) {
              selectedMarker.setMap(null); // Remove old selected marker
            }
            selectedLocation = {
              lat: e.latLng.lat(),
              lng: e.latLng.lng(),
            };

            selectedMarker = new google.maps.Marker({
              position: selectedLocation,
              map: map,
              title: "User Selected Location",
            });

            markers.push(selectedMarker);

            // Show the "Track" button after both points are selected
            if (userLocation && selectedLocation) {
              document.getElementById("trackBtn").style.display = "block";
            }
          }
        });
      }

      // Function to handle directional headlights (left or right)
      function handleDirection(prevLoc, currLoc) {
        const angle = getHeading(prevLoc, currLoc);

        // Calculate if the user is turning left or right
        if (angle < -45 && angle > -135) {
          // Left turn
          directionArrowLeft.style.display = "block";
          directionArrowLeft.style.top = "80px"; // Adjust for your UI position
          directionArrowLeft.style.left = "20px"; // Adjust for your UI position
          directionArrowRight.style.display = "none";
        } else if (angle > 45 && angle < 135) {
          // Right turn
          directionArrowRight.style.display = "block";
          directionArrowRight.style.top = "80px"; // Adjust for your UI position
          directionArrowRight.style.left = "20px"; // Adjust for your UI position
          directionArrowLeft.style.display = "none";
        } else {
          // Straight direction, hide arrows
          directionArrowLeft.style.display = "none";
          directionArrowRight.style.display = "none";
        }
      }

      // Function to calculate the heading (angle) between two points
      function getHeading(loc1, loc2) {
        const lat1 = loc1.lat * (Math.PI / 180);
        const lng1 = loc1.lng * (Math.PI / 180);
        const lat2 = loc2.lat * (Math.PI / 180);
        const lng2 = loc2.lng * (Math.PI / 180);

        const dLng = lng2 - lng1;

        const y = Math.sin(dLng) * Math.cos(lat2);
        const x =
          Math.cos(lat1) * Math.sin(lat2) -
          Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);

        const heading = Math.atan2(y, x);
        return (heading * 180) / Math.PI; // Convert radians to degrees
      }

      // Function to start tracking the route
      function startTracking() {
        if (!userLocation || !selectedLocation) {
          alert("Please select both locations.");
          return;
        }

        // Disable the button to prevent multiple clicks
        document.getElementById("trackBtn").disabled = true;
        document.getElementById("trackBtn").innerHTML = "Tracking..."; // Change button text

        // Disable the map click listener to prevent adding extra markers
        map.setOptions({
          clickableIcons: false,
          gestureHandling: "none",
        });

        // Show the status message and driving icon
        document.getElementById("statusMessage").style.display = "block";
        document.getElementById("drivingIcon").style.display = "block";

        // Request route from the Directions API
        const request = {
          origin: userLocation,
          destination: selectedLocation,
          travelMode: google.maps.TravelMode.DRIVING, // You can also use WALKING, BICYCLING, etc.
        };

        directionsService.route(request, function (result, status) {
          if (status == google.maps.DirectionsStatus.OK) {
            directionsRenderer.setDirections(result);
          } else {
            alert("Unable to calculate the route.");
          }
        });
      }

      // Disable adding new markers once tracking is enabled
      function disableMapClick() {
        map.setOptions({
          clickableIcons: false,
          gestureHandling: "none",
        });
      }
    </script>

    <!-- Load the Google Maps API -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAzf7KnzVx3iLASRh25OP_bYgTpUD-dIW8&libraries=places&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>
